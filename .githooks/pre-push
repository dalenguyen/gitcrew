#!/bin/bash
# Pre-push hook — blocks pushes if tests fail or branch is behind main
# Installed by gitcrew
#
# This prevents agents (and humans) from pushing broken or stale code
# to the shared repository.

# --- Step 1: Check if feature branch is rebased on latest main ---

CURRENT_BRANCH=$(git branch --show-current 2>/dev/null || echo "")

# Only check rebase for non-main branches (agent feature branches)
if [ -n "$CURRENT_BRANCH" ] && [ "$CURRENT_BRANCH" != "main" ] && [ "$CURRENT_BRANCH" != "master" ]; then
    echo "[gitcrew] Checking if branch is up to date with main..."

    # Fetch latest main (quiet, allow failure for offline work)
    git fetch origin main --quiet 2>/dev/null || true

    if git rev-parse --verify origin/main &>/dev/null; then
        # Check if origin/main is an ancestor of the current branch
        if ! git merge-base --is-ancestor origin/main HEAD; then
            echo ""
            echo "=========================================="
            echo "  PUSH BLOCKED — Branch is behind main."
            echo ""
            echo "  Your branch does not contain the latest"
            echo "  changes from origin/main."
            echo ""
            echo "  Run:"
            echo "    git pull --rebase origin main"
            echo ""
            echo "  Then try pushing again."
            echo "=========================================="
            echo ""
            exit 1
        fi
        echo "[gitcrew] Branch is up to date with main."
    fi
fi

# --- Step 2: Run tests ---

echo "[gitcrew] Running pre-push validation..."

if [ -f ".agent/run-tests.sh" ]; then
    bash .agent/run-tests.sh fast
    EXIT_CODE=$?
else
    echo "[gitcrew] Warning: .agent/run-tests.sh not found. Skipping test validation."
    exit 0
fi

if [ $EXIT_CODE -ne 0 ]; then
    echo ""
    echo "=========================================="
    echo "  PUSH BLOCKED — Tests are failing."
    echo "  Fix the failures and try again."
    echo "=========================================="
    echo ""
    exit 1
fi

echo "[gitcrew] All tests passed. Pushing..."
