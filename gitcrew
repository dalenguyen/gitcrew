#!/usr/bin/env bash
#
# gitcrew â€” Parallel & Continuous Agent Teams for Any Codebase
#
# Usage: gitcrew <command> [options]
#
# A CLI toolkit for running multiple AI agents in parallel on a shared repo.
# Inspired by Anthropic's parallel Claude agent teams pattern.
#
set -euo pipefail

VERSION="0.1.0"

# Resolve the real path of this script (handles symlinks on both macOS and Linux)
resolve_path() {
    local target="$1"
    # Follow symlinks (works on macOS without GNU readlink)
    while [ -L "$target" ]; do
        local dir
        dir="$(cd "$(dirname "$target")" && pwd)"
        target="$(readlink "$target")"
        # Handle relative symlinks
        [[ "$target" != /* ]] && target="$dir/$target"
    done
    echo "$(cd "$(dirname "$target")" && pwd)"
}
SCRIPT_DIR="$(resolve_path "$0")"

# Colors and formatting
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m' # No Color

print_logo() {
    echo -e "${CYAN}"
    cat << 'EOF'
          _ _
    __ _ (_) |_ ___ _ __ _____      __
   / _` || | __/ __| '__/ _ \ \ /\ / /
  | (_| || | || (__| | |  __/\ V  V /
   \__, ||_|\__\___|_|  \___| \_/\_/
   |___/
EOF
    echo -e "${NC}"
    echo -e "  ${DIM}Parallel AI Agent Teams for Any Codebase${NC}"
    echo -e "  ${DIM}v${VERSION}${NC}"
    echo ""
}

print_usage() {
    print_logo
    echo -e "${BOLD}USAGE${NC}"
    echo "    gitcrew <command> [options]"
    echo ""
    echo -e "${BOLD}COMMANDS${NC}"
    echo -e "    ${GREEN}init${NC}        Bootstrap .agent/ directory in your repo"
    echo -e "    ${GREEN}spawn${NC}       Start an agent loop (terminal or Docker)"
    echo -e "    ${GREEN}monitor${NC}     Launch the team monitoring dashboard"
    echo -e "    ${GREEN}task${NC}        Manage the agent task board"
    echo -e "    ${GREEN}doctor${NC}      Diagnose project readiness for agents"
    echo -e "    ${GREEN}hooks${NC}       Install git hooks for agent safety"
    echo -e "    ${GREEN}log${NC}         Append to or view the agent log"
    echo -e "    ${GREEN}status${NC}      Quick summary of agent team state"
    echo -e "    ${GREEN}docker${NC}      Manage Docker-based agent containers"
    echo -e "    ${GREEN}pr${NC}          Create issue + PR and run code review before merge"
    echo ""
    echo -e "${BOLD}OPTIONS${NC}"
    echo "    -h, --help       Show this help message"
    echo "    -v, --version    Show version number"
    echo ""
    echo -e "${BOLD}QUICKSTART${NC}"
    echo "    cd your-project/"
    echo "    gitcrew init"
    echo "    gitcrew doctor"
    echo "    gitcrew task add \"Fix: login redirect fails on expired tokens\""
    echo "    gitcrew spawn Agent-A feature"
    echo "    gitcrew monitor"
    echo ""
    echo -e "${BOLD}LEARN MORE${NC}"
    echo "    https://github.com/dalenguyen/gitcrew"
    echo ""
}

# Check if a command file exists and source it
run_command() {
    local cmd="$1"
    shift

    local cmd_file="${SCRIPT_DIR}/commands/${cmd}.sh"

    if [ ! -f "$cmd_file" ]; then
        echo -e "${RED}Error: Unknown command '${cmd}'${NC}"
        echo ""
        echo "Run 'gitcrew --help' to see available commands."
        exit 1
    fi

    # Export shared variables for subcommands
    export GITCREW_DIR="$SCRIPT_DIR"
    export GITCREW_VERSION="$VERSION"
    export GITCREW_RED="$RED"
    export GITCREW_GREEN="$GREEN"
    export GITCREW_YELLOW="$YELLOW"
    export GITCREW_BLUE="$BLUE"
    export GITCREW_CYAN="$CYAN"
    export GITCREW_BOLD="$BOLD"
    export GITCREW_DIM="$DIM"
    export GITCREW_NC="$NC"

    source "$cmd_file" "$@"
}

# --- Main ---

if [ $# -eq 0 ]; then
    print_usage
    exit 0
fi

case "$1" in
    -h|--help)
        print_usage
        exit 0
        ;;
    -v|--version)
        echo "gitcrew v${VERSION}"
        exit 0
        ;;
    --completions)
        shell="${2:-bash}"
        comp_file="${SCRIPT_DIR}/completions/gitcrew.${shell}"
        if [ -f "$comp_file" ]; then
            cat "$comp_file"
        else
            echo "Error: No completions for '${shell}'. Available: bash, zsh" >&2
            exit 1
        fi
        exit 0
        ;;
    init|spawn|monitor|task|doctor|hooks|log|status|docker|pr)
        run_command "$@"
        ;;
    *)
        echo -e "${RED}Error: Unknown command '$1'${NC}"
        echo ""
        echo "Run 'gitcrew --help' to see available commands."
        exit 1
        ;;
esac
